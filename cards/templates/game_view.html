{% extends "main.html" %}

{% load url from future %}
{% load socialaccount %}

{% block login %}
<nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="navbar-header">
        <a href="https://twitter.com/share?url=http://thisisnotthatgame.com/{{ game.id }}/join&count=none&via=notthatgame" class="twitter-share-button" data-lang="en" data-text="I'm definitely not playing that game. Come join me.">Tweet</a><span class="text-primary"> so friends can join this game!</span>
        {% if user.is_authenticated %}
        Welcome, {{ user.email }}
        <a class="btn btn-sm navbar-btn" href="{% url 'account_logout' %}">Sign Out</a>
        {% else %}
            <a class="btn btn-primary btn-sm navbar-btn " href="{% provider_login_url 'facebook' method='oauth2' next='/'%}">Login with Facebook</a>
            <a class="btn btn-primary btn-sm navbar-btn " href="{% provider_login_url 'twitter' method='oauth2' next='/'%}">Login with Twitter</a>
        {% endif %}
        {% if player_name %}
        <a class="btn btn-sm btn-danger" href="exit">Exit game</a>
        {% endif %}
    </div>
</nav>
{% endblock %}

{% block content %}
<div class="container">

    <div class="page-header">
            <h2>
                {% if filled_in_question %}
                    {{filled_in_question|safe}}
                {% else %}
                    {{black_card|safe}}
                {% endif %}
            </h2>
            <p class="text-muted">
            {% if game.game_state == 'submission' %}
                <span class="badge">{{game.gamedata.submissions|length}}</span> out of <span class="badge">{{game.gamedata.players|length|add:"-1"}}</span> players have submitted.
                {% if waiting_on %}
                Waiting on:
                {% for player in waiting_on %}
                    {{ player }}, 
                {% endfor %}
                {% endif %}
            {% elif game.game_state == 'selection' %}
                Waiting for Card Critic to make selection.
                {% if is_card_czar %}
                (That's you!)
                {% endif %}
            {% endif %}
            </p>
    </div>

    {% if show_form %}
        <form action="{{ action }}" method="post">
            {% csrf_token %}
            {% for field_err1, field_err2  in form.errors.items %}
            <p class="text-error"><strong>{{field_err2}}</strong></p>
            {% endfor %}
            {% for field in form %}
            <div class="field">
                {% if is_card_czar %}
                    Select the winner:
                {% endif %}
                {{field|safe}}
            </div>
            </br>
            {% endfor %}
        <input type="submit" class="btn btn-primary" value="Submit" />
        </form>
    {% endif %}
</br>
    {% if game.game_state == 'selection' %}
    <div class="panel panel-default">
        <div class="panel-heading">
            <div class="panel-title">Submitted cards</div>
        </div>
        {% comment %}
            <!--  TODO make me pretty (and then the same for white_cards_text_list) -->
            <!--  TODO haiku card could be prettier (possibly requires commas adding in replace_blanks) -->
        {% endcomment %}
        <div class="list-group">
        {% for _, tmp_text in game.gamedata.filled_in_texts %}
            <div class="list-group-item">
            {{tmp_text|safe}}
            </div>
        {% endfor %}
        </div>
    </div>
        </br>
    {% endif %}

    <p>
        {% comment %}
            <!-- NOTE There are some model/template magic string value dependencies here :-( -->
        {% endcomment %}
        
            {% comment %}
                <!--  TODO dump card count, how many players are we waiting for? -->
            {% endcomment %}
        {% if game.game_state == 'selection' %}
            Waiting for card critic, <img src="{{card_czar_avatar}}" alt="Card critic avatar"> {{card_czar_name}} to pick a winner.
        {% endif %}
    </p>
    
    <p>
        <img src="{{card_czar_avatar}}" alt="Card critic avatar">
        {% if card_czar_name == player_name %}
            You are the Card Critic!
        {% else %}
        {{card_czar_name}} is the card critic, all hail {{card_czar_name}}
        {% endif %}
        {% if game.gamedata.prev_filled_in_question %}
            for the classic;
            <div class="btn btn-inverse">
                {{game.gamedata.prev_filled_in_question|safe}}
            </div>
        {% endif %}
    </p>

    <p>Game: {{game.name}}, Round {{game.gamedata.round}}.</p>
    <p>
    {% if not player_name %}
    You are an observer. <a class="btn" href="join">Join this game</a>
    {% endif %}
    </p>

    <div class="row">
        <div class="col-md-6">
        {% include "stats.html" %}
        </div>
        <div class="col-md-6">
        {% include "submissions.html" %}
        </div>
    </div>
    
    {% comment %}
    <!--  TODO previous winning cards (filled in) -->
    {% endcomment %}

</div>
{% endblock %}

{% block scripts %}
    <script type="text/javascript" src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
    <script src="http://{{ socketio }}:8080/socket.io/socket.io.js"></script>
    {% if not show_form %}
    <script type="text/javascript">
        var room = '{{ room_name }}'
        var socket = io.connect('http://{{ socketio }}:8080');
        socket.on('connect', function(){
            socket.emit('room', room);
        });
        socket.on('reload', function (data) {
            location.reload(true);
        });
    </script>
    {% endif %}
    <script>
    !function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="https://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");
    </script>
{% endblock %}
